<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
<title>Island Coconut Spirits</title>
<style>
  body {
    margin: 0;
    overflow: hidden;
    background: #7ecbdc;
    touch-action: none;
  }
  canvas { display: block; }
</style>
</head>
<body>

<canvas id="game"></canvas>

<script>
// =======================
// SETUP
// =======================

const canvas = document.getElementById("game");
const ctx = canvas.getContext("2d");

function resize() {
  canvas.width = window.innerWidth;
  canvas.height = window.innerHeight;
}
window.addEventListener("resize", resize);
resize();

// =======================
// AUDIO
// =======================

const audioCtx = new (window.AudioContext || window.webkitAudioContext)();

function playHitSound() {
  const o = audioCtx.createOscillator();
  const g = audioCtx.createGain();
  o.type = "sine";
  o.frequency.value = 220;
  g.gain.value = 0.05;
  o.connect(g);
  g.connect(audioCtx.destination);
  o.start();
  o.stop(audioCtx.currentTime + 0.08);
}

function playPopSound() {
  const o = audioCtx.createOscillator();
  const g = audioCtx.createGain();
  o.type = "triangle";
  o.frequency.setValueAtTime(600, audioCtx.currentTime);
  o.frequency.exponentialRampToValueAtTime(200, audioCtx.currentTime + 0.15);
  g.gain.setValueAtTime(0.06, audioCtx.currentTime);
  g.gain.exponentialRampToValueAtTime(0.001, audioCtx.currentTime + 0.15);
  o.connect(g);
  g.connect(audioCtx.destination);
  o.start();
  o.stop(audioCtx.currentTime + 0.16);
}
  // =======================
// BACKGROUND MUSIC
// =======================

let music;
let musicStarted = false;

function initMusic() {
  if (musicStarted) return;

  music = new Audio("island.mp3"); // or "island.wav"
  music.loop = true;
  music.volume = 0.4;

  music.play().catch(() => {
    // Mobile browsers require user interaction
    console.log("Music will start on first touch");
  });

  musicStarted = true;
}


// =======================
// GAME STATE
// =======================

const player = {
  x: canvas.width / 2,
  y: 0,
  width: 40,
  height: 60,
  hp: 3,
  power: 1
};

const coconuts = [];
const spirits = [];

let difficulty = 1;
let spawnTimer = 0;
let touchX = null;
let survivalTime = 0;
let waveTime = 0;

// =======================
// INPUT
// =======================

canvas.addEventListener("touchstart", e => {
  touchX = e.touches[0].clientX;
  shoot();
});
canvas.addEventListener("touchmove", e => {
  touchX = e.touches[0].clientX;
});
canvas.addEventListener("touchstart", e => {
  if (audioCtx.state === "suspended") {
    audioCtx.resume();
  }

  initMusic(); // ðŸŽµ start island music
  touchX = e.touches[0].clientX;
  shoot();
});


// =======================
// GAME LOGIC
// =======================

function shoot() {
  for (let i = 0; i < player.power; i++) {
    coconuts.push({
      x: player.x + player.width / 2,
      y: player.y,
      vx: (i - (player.power - 1) / 2) * 0.8,
      vy: -6
    });
  }
}

function spawnSpirit() {
  spirits.push({
    x: Math.random() * (canvas.width - 28),
    y: -30,
    size: 28, // smaller spirits
    hp: Math.random() < Math.min(0.4, difficulty * 0.1) ? 2 : 1,
    speed: 1.3 + difficulty * 0.25,
    wobble: Math.random() * Math.PI * 2
  });
}

function update() {
  survivalTime += 1 / 60;
  waveTime += 0.01;

  difficulty = 1 + survivalTime * 0.06;

  player.y = canvas.height - player.height - 20;

  if (touchX !== null) {
    player.x = touchX - player.width / 2;
    player.x = Math.max(0, Math.min(canvas.width - player.width, player.x));
  }

  spawnTimer++;
  const spawnRate = Math.max(20, 90 - difficulty * 14);

  if (spawnTimer > spawnRate) {
    const wave = Math.min(1 + Math.floor(difficulty * 0.35), 6);
    for (let i = 0; i < wave; i++) spawnSpirit();
    spawnTimer = 0;
  }

  coconuts.forEach(c => {
    c.x += c.vx;
    c.y += c.vy;
  });

  spirits.forEach(s => {
    s.wobble += 0.05;
    s.y += s.speed;
    s.x += Math.sin(s.wobble) * 0.6;
  });

  spirits.forEach((s, si) => {
    coconuts.forEach((c, ci) => {
      if (
        c.x > s.x &&
        c.x < s.x + s.size &&
        c.y > s.y &&
        c.y < s.y + s.size
      ) {
        s.hp--;
        coconuts.splice(ci, 1);
        playHitSound();
        if (s.hp <= 0) {
          spirits.splice(si, 1);
          playPopSound();
        }
      }
    });

    if (
      s.x < player.x + player.width &&
      s.x + s.size > player.x &&
      s.y < player.y + player.height &&
      s.y + s.size > player.y
    ) {
      spirits.splice(si, 1);
      player.hp--;
    }
  });
}

// =======================
// DRAWING
// =======================

function drawBackground() {
  // Sky + ocean
  const g = ctx.createLinearGradient(0, 0, 0, canvas.height);
  g.addColorStop(0, "#a7ddf2");
  g.addColorStop(0.5, "#6bc4d6");
  g.addColorStop(1, "#2f6f7e");
  ctx.fillStyle = g;
  ctx.fillRect(0, 0, canvas.width, canvas.height);

  // Ocean waves
  ctx.fillStyle = "rgba(255,255,255,0.15)";
  for (let i = 0; i < canvas.width; i += 40) {
    ctx.beginPath();
    ctx.arc(
      i,
      canvas.height * 0.55 + Math.sin(waveTime + i * 0.05) * 4,
      20,
      0,
      Math.PI
    );
    ctx.fill();
  }

  // Island
  ctx.fillStyle = "#2d5a3a";
  ctx.beginPath();
  ctx.moveTo(0, canvas.height * 0.45);
  ctx.quadraticCurveTo(
    canvas.width * 0.5,
    canvas.height * 0.3,
    canvas.width,
    canvas.height * 0.45
  );
  ctx.lineTo(canvas.width, canvas.height);
  ctx.lineTo(0, canvas.height);
  ctx.fill();

  // Palm trees
  ctx.strokeStyle = "#1f3d28";
  ctx.lineWidth = 4;
  for (let i = 0; i < 3; i++) {
    const x = canvas.width * (0.2 + i * 0.3);
    const y = canvas.height * 0.45;
    ctx.beginPath();
    ctx.moveTo(x, y);
    ctx.lineTo(x - 10, y - 40);
    ctx.stroke();

    ctx.beginPath();
    ctx.arc(x - 10, y - 42, 20, Math.PI, Math.PI * 1.5);
    ctx.stroke();
  }
}

function drawPlayer() {
  // Back hair
  ctx.fillStyle = "#111";
  ctx.beginPath();
  ctx.ellipse(player.x + 20, player.y + 30, 16, 26, 0, Math.PI, Math.PI * 2);
  ctx.fill();

  // Head
  ctx.fillStyle = "#6b3e26";
  ctx.beginPath();
  ctx.arc(player.x + 20, player.y + 14, 12, 0, Math.PI * 2);
  ctx.fill();

  // Bangs
  ctx.fillStyle = "#111";
  ctx.beginPath();
  ctx.arc(player.x + 20, player.y + 10, 14, Math.PI, Math.PI * 2);
  ctx.fill();

  // Face
  ctx.fillStyle = "#000";
  ctx.beginPath();
  ctx.arc(player.x + 14, player.y + 14, 1.5, 0, Math.PI * 2);
  ctx.arc(player.x + 26, player.y + 14, 1.5, 0, Math.PI * 2);
  ctx.fill();

  ctx.strokeStyle = "#000";
  ctx.beginPath();
  ctx.arc(player.x + 20, player.y + 18, 4, 0, Math.PI);
  ctx.stroke();

  // Arms
  ctx.strokeStyle = "#6b3e26";
  ctx.lineWidth = 3;
  ctx.beginPath();
  ctx.moveTo(player.x + 12, player.y + 32);
  ctx.lineTo(player.x + 6, player.y + 40);
  ctx.moveTo(player.x + 28, player.y + 32);
  ctx.lineTo(player.x + 34, player.y + 40);
  ctx.stroke();

  // Body
  ctx.fillRect(player.x + 10, player.y + 26, 20, 26);

  // Grass skirt
  ctx.strokeStyle = "#5a8f3a";
  ctx.lineWidth = 2;
  for (let i = -10; i <= 10; i += 4) {
    ctx.beginPath();
    ctx.moveTo(player.x + 20 + i, player.y + 52);
    ctx.lineTo(player.x + 18 + i, player.y + 72);
    ctx.stroke();
  }
}

function drawSpirits() {
  spirits.forEach(s => {
    ctx.fillStyle = "#000000cc";
    ctx.beginPath();
    ctx.ellipse(
      s.x + s.size / 2,
      s.y + s.size / 2,
      s.size / 2,
      s.size / 2,
      0,
      0,
      Math.PI * 2
    );
    ctx.fill();

    ctx.fillStyle = "white";
    ctx.beginPath();
    ctx.arc(s.x + 9, s.y + 12, 3, 0, Math.PI * 2);
    ctx.arc(s.x + 18, s.y + 16, 2.5, 0, Math.PI * 2);
    ctx.fill();
  });
}

function drawCoconuts() {
  ctx.fillStyle = "#8b5a2b";
  coconuts.forEach(c => {
    ctx.beginPath();
    ctx.arc(c.x, c.y, 6, 0, Math.PI * 2);
    ctx.fill();
  });
}

function drawUI() {
  ctx.fillStyle = "white";
  ctx.font = "18px sans-serif";
  ctx.fillText("â¤ " + player.hp, 15, 25);
}

function draw() {
  drawBackground();
  drawPlayer();
  drawCoconuts();
  drawSpirits();
  drawUI();
}

// =======================
// LOOP
// =======================

function loop() {
  update();
  draw();
  if (player.hp > 0) requestAnimationFrame(loop);
  else {
    ctx.fillStyle = "black";
    ctx.font = "40px sans-serif";
    ctx.fillText("Game Over", canvas.width / 2 - 100, canvas.height / 2);
  }
}

loop();
</script>

</body>
</html>
