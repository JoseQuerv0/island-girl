<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
<title>Island Coconut Spirits</title>
<style>
  body {
    margin: 0;
    overflow: hidden;
    background: #7ecbdc;
    touch-action: none;
  }
  canvas { display: block; }

  #restartBtn {
    position: absolute;
    left: 50%;
    top: 60%;
    transform: translate(-50%, -50%);
    padding: 14px 28px;
    font-size: 18px;
    border: none;
    border-radius: 8px;
    background: #2d5a3a;
    color: white;
    display: none;
    z-index: 10;
  }
</style>
</head>
<body>

<canvas id="game"></canvas>
<button id="restartBtn">Restart</button>

<script>
// =======================
// SETUP
// =======================

const canvas = document.getElementById("game");
const ctx = canvas.getContext("2d");
const restartBtn = document.getElementById("restartBtn");

function resize() {
  canvas.width = window.innerWidth;
  canvas.height = window.innerHeight;
}
window.addEventListener("resize", resize);
resize();

// =======================
// AUDIO
// =======================

const audioCtx = new (window.AudioContext || window.webkitAudioContext)();

function playHitSound() {
  const o = audioCtx.createOscillator();
  const g = audioCtx.createGain();
  o.type = "sine";
  o.frequency.value = 220;
  g.gain.value = 0.05;
  o.connect(g);
  g.connect(audioCtx.destination);
  o.start();
  o.stop(audioCtx.currentTime + 0.08);
}

function playPopSound() {
  const o = audioCtx.createOscillator();
  const g = audioCtx.createGain();
  o.type = "triangle";
  o.frequency.setValueAtTime(600, audioCtx.currentTime);
  o.frequency.exponentialRampToValueAtTime(200, audioCtx.currentTime + 0.15);
  g.gain.setValueAtTime(0.06, audioCtx.currentTime);
  g.gain.exponentialRampToValueAtTime(0.001, audioCtx.currentTime + 0.15);
  o.connect(g);
  g.connect(audioCtx.destination);
  o.start();
  o.stop(audioCtx.currentTime + 0.16);
}

// =======================
// BACKGROUND MUSIC
// =======================

let music;
let musicStarted = false;

function startMusic() {
  if (musicStarted) return;
  music = new Audio("island.mp3");
  music.loop = true;
  music.volume = 0.18;
  music.play().catch(() => {});
  musicStarted = true;
}

// =======================
// GAME STATE
// =======================

let player, coconuts, spirits, family;
let difficulty, spawnTimer, touchX, survivalTime, waveTime;
let gameOver = false;
let animating = false;

function initGame() {
  player = {
    x: canvas.width / 2,
    y: 0,
    width: 40,
    height: 60,
    hp: 3,
    power: 1
  };

  family = [
    { offset: -80, scale: 1.0, fear: 0, type: "girl" },
    { offset: -35, scale: 1.0, fear: 0, type: "girl" },
    { offset:  20, scale: 0.85, fear: 0, type: "girl" },
    { offset:  60, scale: 0.75, fear: 0, type: "boy" }
  ];

  coconuts = [];
  spirits = [];

  difficulty = 1;
  spawnTimer = 0;
  touchX = null;
  survivalTime = 0;
  waveTime = 0;
  gameOver = false;

  restartBtn.style.display = "none";

  if (!animating) {
    animating = true;
    loop();
  }
}

// =======================
// INPUT
// =======================

canvas.addEventListener("touchstart", e => {
  audioCtx.resume();
  startMusic();
  touchX = e.touches[0].clientX;
  shoot();
});
canvas.addEventListener("touchmove", e => {
  touchX = e.touches[0].clientX;
});
canvas.addEventListener("touchend", () => {
  touchX = null;
});

restartBtn.addEventListener("click", initGame);
restartBtn.addEventListener("touchstart", initGame);

// =======================
// GAME LOGIC
// =======================

function shoot() {
  for (let i = 0; i < player.power; i++) {
    coconuts.push({
      x: player.x + player.width / 2,
      y: player.y,
      vx: (i - (player.power - 1) / 2) * 0.8,
      vy: -6
    });
  }
}

function spawnSpirit() {
  spirits.push({
    x: Math.random() * (canvas.width - 28),
    y: -30,
    size: 28,
    hp: Math.random() < Math.min(0.4, difficulty * 0.1) ? 2 : 1,
    speed: 1.3 + difficulty * 0.25,
    wobble: Math.random() * Math.PI * 2
  });
}

function update() {
  if (gameOver) return;

  survivalTime += 1 / 60;
  waveTime += 0.01;
  difficulty = 1 + survivalTime * 0.06;

  player.y = canvas.height - player.height - 100;

  if (touchX !== null) {
    player.x = touchX - player.width / 2;
    player.x = Math.max(0, Math.min(canvas.width - player.width, player.x));
  }

  spawnTimer++;
  const spawnRate = Math.max(20, 90 - difficulty * 14);

  if (spawnTimer > spawnRate) {
    const wave = Math.min(1 + Math.floor(difficulty * 0.35), 6);
    for (let i = 0; i < wave; i++) spawnSpirit();
    spawnTimer = 0;
  }

  coconuts.forEach(c => {
    c.x += c.vx;
    c.y += c.vy;
  });

  family.forEach(f => f.fear *= 0.9);

  spirits.forEach((s, si) => {
    s.wobble += 0.05;
    s.y += s.speed;
    s.x += Math.sin(s.wobble) * 0.6;

    if (s.y + s.size > canvas.height - 60) {
      gameOver = true;
      restartBtn.style.display = "block";
    }

    if (s.y > canvas.height - 160) {
      family.forEach(f => f.fear = Math.min(1, f.fear + 0.05));
    }

    coconuts.forEach((c, ci) => {
      if (
        c.x > s.x &&
        c.x < s.x + s.size &&
        c.y > s.y &&
        c.y < s.y + s.size
      ) {
        s.hp--;
        coconuts.splice(ci, 1);
        playHitSound();
        if (s.hp <= 0) {
          spirits.splice(si, 1);
          playPopSound();
        }
      }
    });
  });
}

// =======================
// DRAWING
// =======================

function drawBackground() {
  // Gentle sunset factor
  const sunset = Math.min(1, survivalTime / 120);

  // Sky
  const g = ctx.createLinearGradient(0, 0, 0, canvas.height);
  g.addColorStop(0, `rgb(${167 + sunset * 40}, ${221 - sunset * 60}, ${242 - sunset * 80})`);
  g.addColorStop(0.5, `rgb(${107 + sunset * 60}, ${196 - sunset * 40}, ${214 - sunset * 60})`);
  g.addColorStop(1, "#2f6f7e");
  ctx.fillStyle = g;
  ctx.fillRect(0, 0, canvas.width, canvas.height);

  // Ocean waves
  ctx.fillStyle = "rgba(255,255,255,0.15)";
  for (let i = 0; i < canvas.width; i += 40) {
    ctx.beginPath();
    ctx.arc(
      i,
      canvas.height * 0.52 + Math.sin(waveTime + i * 0.05) * 4,
      20,
      0,
      Math.PI
    );
    ctx.fill();
  }

  // Beach (expanded)
  ctx.fillStyle = "#e8d2a6";
  ctx.fillRect(0, canvas.height * 0.55, canvas.width, canvas.height * 0.15);

  // Sand variation
  ctx.fillStyle = "rgba(0,0,0,0.05)";
  for (let i = 0; i < canvas.width; i += 60) {
    ctx.fillRect(i, canvas.height * 0.58, 30, 4);
  }

  // Island
  ctx.fillStyle = "#2d5a3a";
  ctx.beginPath();
  ctx.moveTo(0, canvas.height * 0.65);
  ctx.quadraticCurveTo(
    canvas.width * 0.5,
    canvas.height * 0.5,
    canvas.width,
    canvas.height * 0.65
  );
  ctx.lineTo(canvas.width, canvas.height);
  ctx.lineTo(0, canvas.height);
  ctx.fill();

  // Palm trees with leaves + coconuts
  ctx.strokeStyle = "#1f3d28";
  ctx.lineWidth = 4;
  ctx.fillStyle = "#1f3d28";

  for (let i = 0; i < 3; i++) {
    const x = canvas.width * (0.2 + i * 0.3);
    const y = canvas.height * 0.65;

    // Trunk
    ctx.beginPath();
    ctx.moveTo(x, y);
    ctx.lineTo(x - 10, y - 40);
    ctx.stroke();

    // Leaves
    for (let a = -1; a <= 1; a++) {
      ctx.beginPath();
      ctx.moveTo(x - 10, y - 40);
      ctx.lineTo(x - 10 + a * 30, y - 60);
      ctx.stroke();
    }

    // Coconuts
    ctx.fillStyle = "#6b4a2b";
    ctx.beginPath();
    ctx.arc(x - 10, y - 38, 4, 0, Math.PI * 2);
    ctx.arc(x - 16, y - 36, 4, 0, Math.PI * 2);
    ctx.arc(x - 4, y - 36, 4, 0, Math.PI * 2);
    ctx.fill();
  }
}

function drawPerson(x, y, scale, type, fear) {
  ctx.save();
  ctx.translate(x, y + Math.sin(fear * 10) * 3);
  ctx.scale(scale, scale);

  if (type === "girl") {
    ctx.fillStyle = "#111";
    ctx.beginPath();
    ctx.ellipse(20, 30, 16, 26, 0, Math.PI, Math.PI * 2);
    ctx.fill();
  }

  ctx.fillStyle = "#6b3e26";
  ctx.beginPath();
  ctx.arc(20, 14, 12, 0, Math.PI * 2);
  ctx.fill();

  ctx.fillStyle = "#111";
  ctx.beginPath();
  ctx.arc(20, type === "girl" ? 10 : 12, 14, Math.PI, Math.PI * 2);
  ctx.fill();

  ctx.fillStyle = "#000";
  ctx.beginPath();
  ctx.arc(14, 14, 1.5, 0, Math.PI * 2);
  ctx.arc(26, 14, 1.5, 0, Math.PI * 2);
  ctx.fill();

  ctx.strokeStyle = "#000";
  ctx.beginPath();
  ctx.arc(20, 18, 4, 0, Math.PI);
  ctx.stroke();

  ctx.fillRect(10, 26, 20, 26);

  if (type === "boy") {
    ctx.fillStyle = "#3b6c8a";
    ctx.fillRect(10, 44, 20, 10);
  } else {
    ctx.strokeStyle = "#5a8f3a";
    ctx.lineWidth = 2;
    for (let i = -10; i <= 10; i += 4) {
      ctx.beginPath();
      ctx.moveTo(20 + i, 52);
      ctx.lineTo(18 + i, 72);
      ctx.stroke();
    }
  }

  ctx.restore();
}

function drawFamily() {
  const baseY = canvas.height - 80;
  family.forEach(f => {
    drawPerson(canvas.width / 2 + f.offset, baseY, f.scale, f.type, f.fear);
  });
}

function drawPlayer() {
  drawPerson(player.x, player.y, 1, "girl", 0);
}

function drawSpirits() {
  spirits.forEach(s => {
    ctx.fillStyle = "#000000cc";
    ctx.beginPath();
    ctx.ellipse(
      s.x + s.size / 2,
      s.y + s.size / 2,
      s.size / 2,
      s.size / 2,
      0,
      0,
      Math.PI * 2
    );
    ctx.fill();

    ctx.fillStyle = "white";
    ctx.beginPath();
    ctx.arc(s.x + 9, s.y + 12, 3, 0, Math.PI * 2);
    ctx.arc(s.x + 18, s.y + 16, 2.5, 0, Math.PI * 2);
    ctx.fill();
  });
}

function drawCoconuts() {
  ctx.fillStyle = "#8b5a2b";
  coconuts.forEach(c => {
    ctx.beginPath();
    ctx.arc(c.x, c.y, 6, 0, Math.PI * 2);
    ctx.fill();
  });
}

function drawUI() {
  ctx.fillStyle = "white";
  ctx.font = "18px sans-serif";
  ctx.fillText("‚ù§ " + player.hp, 15, 25);
}

function draw() {
  drawBackground();
  drawFamily();
  drawPlayer();
  drawCoconuts();
  drawSpirits();
  drawUI();

  if (gameOver) {
    ctx.fillStyle = "black";
    ctx.font = "40px sans-serif";
    ctx.fillText("Game Over", canvas.width / 2 - 100, canvas.height / 2);
  }
}

// =======================
// LOOP
// =======================

function loop() {
  update();
  draw();
  requestAnimationFrame(loop);
}

// =======================
// START
// =======================

initGame();
</script>

</body>
</html>
